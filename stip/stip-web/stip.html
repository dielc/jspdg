<!DOCTYPE html>
<html lang="en">

<head>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <link rel='shortcut icon' type='image/x-icon' href='favicon.ico' />

    <link rel="stylesheet" href="css/bootstrap.css"/> 
    <link rel="stylesheet" href="css/starter-template.css"/>
    <link rel="stylesheet" href="css/bootstrap-toggle.css"/>
    <link rel="stylesheet" href="protopurity.css" type="text/css" media="all"/> 
    <link rel="stylesheet" href="lib/jquery-ui.min.css"/>

    <title>STiP.js</title>
    <!-- Le javascript-->
    <!-- Jipda -->
    <script type="text/javascript" src="../lib/esprima.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/common.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/ast.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/agc.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/lattice.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/abstLattice1-2.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/concLattice.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/countingStore.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/graph.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/jsCesk.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/concreteAg.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/tagAg.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/benv.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/object.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/lib/web/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/lib/web/jquery-ui-1.11.1/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/lib/web/codemirror/codemirror.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/lib/web/codemirror/hint/show-hint.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/lib/web/codemirror/hint/anyword-hint.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/lib/web/codemirror/mode/javascript/javascript.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/lib/web/d3.min.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/lib/web/dagre-d3.min.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/lib/web/dagregraphs.js"></script>
    <script type="text/javascript" src="../../jipda-pdg/pdg/pdg.js"></script>

    <!--/end Jipda -->

    <script type="text/javascript" src="examples.js"></script>
    <script src="../lib/esprima.js"></script>
    <script src="../lib/falafel_esprima.js"></script>
    <script src="../lib/estraverse.js"></script>
    <script src="../lib/escope.js"></script>
    <script src="../lib/esrefactor.js"></script>
    <script src="../lib/json2.js"></script>
    <script src="../lib/beautifier.js"></script>
    <script src="lib/ace/ace.js"></script>
    <script type="text/javascript" src="../lib/falafel.js"></script>
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="http://yui.yahooapis.com/3.9.0/build/yui/yui-min.js"></script>
    <script src="lib/jquery-ui.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/bootstrap-toggle.min.js"></script>
    <script src="js/prettify.js"></script>
    <script src="js/tab.js"></script>
    <script src="js/transition.js"></script>
    <script src="js/collapse.js"></script>
    <script type="text/javascript" src="../aux.js"></script>
    <script type="text/javascript" src="../handler-transform.js"></script>
	<script type="text/javascript" src="../handler-predefined.js"></script>
	<script type="text/javascript" src="../handler-generate.js"></script>
	<script type="text/javascript" src="../handler.js"></script>
    <script type="text/javascript" src="../PDG/edge.js"></script>
    <script type="text/javascript" src="../PDG/node.js"></script>
    <script type="text/javascript" src="../PDG/graph.js"></script>
    <script type="text/javascript" src="../pre-analysis.js"></script>
    <script type="text/javascript" src="../jipdatool.js"></script>
    <script type="text/javascript" src="../annotations.js"></script>
    <script type="text/javascript" src="js/esprimatool.js"></script>
    <script type="text/javascript" src="lib/jslint.js"></script>
    <script type="text/javascript" src="js/jslinttool.js"></script>
    <script type="text/javascript" src="../stip.js"></script>
    <script type="text/javascript" src="../stip2.js"></script>
    <script type="text/javascript" src="../transpiler/CPS_transform.js"></script>
    <script type="text/javascript" src="../transpiler/Promise_transform.js"></script>
    <script type="text/javascript" src="../transpiler/CT_transform.js"></script>
    <script type="text/javascript" src="../transpiler/JS_parse.js"></script>
    <script type="text/javascript" src="../transpiler/Meteor_parse.js"></script>
    <script type="text/javascript" src="../transpiler/Node_parse.js"></script>
    <script type="text/javascript" src="../transpiler/JSify.js"></script>
    <script type="text/javascript" src="../transpiler/Meteorify.js"></script>
    <script type="text/javascript" src="../transpiler/Nodeify.js"></script>
    <script type="text/javascript" src="../transpiler/CT_parse.js"></script>
    <script type="text/javascript" src="../transpiler/slice.js"></script>
    <script type="text/javascript" src="../lib/escodegen.browser.js"></script>
    <script type="text/javascript" src="PDGgraph.js"></script>
    <script type="text/javascript" src="pdgGraphs.js"></script>
    <script type="text/javascript" src="lib/viz.js"></script>
    <script type="text/javascript">

    // define print method for JIPDA
    var print = function () { console.log(Array.prototype.slice.call(arguments).join(" ")) },       
        editor, slicededitor, result, PDGg, clientprogram, serverprogram, assumes;

    function doIt () {
        try {

            $("#graph").empty();
            $("#error").empty();
            var src = editor.getSession().getValue(),
            // First parse and create again via escodegen

            ast = Ast.createAst(src, {loc:true, owningComments: true, comment: true});
			Handler.init();

			/* Pre analysis step */
      		var preanalysis = pre_analyse(ast);
            console.log(preanalysis.src);
            assumes = preanalysis.assumes;
            var src = editor.getSession().getValue(),
                ast = Ast.createAst(preanalysis.src, {loc:true, owningComments: true});
            $("#graph").empty();
            graphs = new Stip.Graphs(ast, src);
            Stip.start(graphs);
            var g = createPDGGraph(graphs.PDG);

            drawPDGGraph(g[0], g[1], g[2], g[3]);
            return graphs; 
        } catch (err) {
            console.log(err.message);
            $("#error").empty();
            $("#error").append(err.stack);
        }
      }

      function printCode () {
            var concatCode = function (code) {
                slicededitor.setValue(slicededitor.getValue() +
                    code + "\n")
            }
            slicededitor.setValue('');
            if ($("#includeclient").prop('checked') && $("#includesetup").prop('checked')) {
                concatCode("/* CLIENT */"); 
                concatCode(escodegen.generate(clientprogram.program)) 
            }
            else if ($("#includeclient").prop('checked')) {
                concatCode("/* CLIENT */");
                concatCode(escodegen.generate(clientprogram.nosetup))
            }
            else if ($("#includesetup").prop('checked')) {
                concatCode("/* CLIENT */");
                concatCode(escodegen.generate(clientprogram.setup))
            }
            if ($("#includeserver").prop('checked') && $("#includesetup").prop('checked')) {
                concatCode("/* SERVER */");
                concatCode(escodegen.generate(serverprogram.program))
            }
            else if ($("#includeserver").prop('checked')) {
                concatCode("/* SERVER */");
                concatCode(escodegen.generate(serverprogram.nosetup))
            }
            else if ($("#includesetup").prop('checked')) {
                concatCode("/* SERVER */");
                concatCode(escodegen.generate(serverprogram.setup))
            }
      }

      function split () { 
        try {
            var graphs  = doIt(),
                PDG     = graphs.PDG;
            PDGg = graphs;
            slicededitor.setValue("");
            //$('.collapse').collapse();
            var slicedc = PDG.sliceDistributedNode(PDG.dclient),
                sliceds = PDG.sliceDistributedNode(PDG.dserver),
                sortedc = slicedc.slice(0),
                sorteds = sliceds.slice(0),
                removes  = [],
                assumesnames = assumes.map(function (ass) {return ass.declarations[0].id.name.trim()}),
                program,
                splitCode = function (nodes, option) {
                    nodes.sort(function (n1, n2) {
                        return n1.cnt - n2.cnt;
                    })
                    var target  = $('#target').val(),
                        asyncomm = $('#asyncomm').val(),
                        program = constructProgram(nodes, {target: target, tier: option, asynccomm : asyncomm});
                    return program;
                };
            /* Filter out nodes that were added by the assumes statement */
            sortedc = sortedc.filter(function (pdgnode) {
                if (pdgnode.parsenode)
                    if (esp_isVarDecl(pdgnode.parsenode) &&
                        assumesnames.indexOf(pdgnode.parsenode.declarations[0].id.name) > -1) {
                        removes = removes.concat(pdgnode)
                        return false
                    } else
                        return true
                else
                    return true
            });
            sorteds = sorteds.filter(function (pdgnode) {
                if (pdgnode.parsenode)
                    if (esp_isVarDecl(pdgnode.parsenode) &&
                        assumesnames.indexOf(pdgnode.parsenode.declarations[0].id.name) > -1) {
                        removes = removes.concat(pdgnode)
                        return false
                    } else
                        return true
                else
                    return true
            });
            removes.map(function (node) {
                var entry  = node.getOutEdges(EDGES.DATA)
                                .map( function (edge) {return edge.to})
                                .filter (function (node) {return node.isEntryNode})[0],
                    params = entry.getFormalIn().concat(entry.getFormalOut()),
                    body   = entry.getBody();
                sorteds = sorteds.remove(entry); sortedc = sortedc.remove(entry);
                params.map(function (param) {sorteds = sorteds.remove(param); sortedc = sortedc.remove(param)})
                body.map(function (bodynode) {sorteds = sorteds.remove(bodynode); sortedc = sortedc.remove(bodynode)})
            })
            clientprogram =  splitCode(sortedc, "client");
            serverprogram = splitCode(sorteds, "server");
            printCode()
        } catch (err) {
            console.log(err.stack);
            $("#error").append(err.message);
        }
      }


      function cpstransform () {
        try {
            slicededitor.setValue("");
            var graphs  = doIt(),
                PDG     = graphs.PDG,
                program = constructProgram(PDG.getAllNodes(), {target: 'normal', cps : true});
            slicededitor.setValue(escodegen.generate(program));
        } catch (err) {
            console.log(err.stack);
            $("#error").append(err.message);
        }
      }


      $(function () {
        editor = ace.edit("editor");
        editor.getSession().setUseWorker(false);
        editor.getSession().setMode("ace/mode/javascript");
        slicededitor = ace.edit("slicededitor");
        slicededitor.getSession().setUseWorker(false);
        slicededitor.getSession().setMode("ace/mode/javascript");

        editor.setValue(Examples.tiersplitexs[0]);
        editor.gotoLine(0);
        editor.focus();
        editor.commands.addCommand({
            name: 'split',
            bindKey: {win: 'Ctrl-s', mac: 'Command-s'},
            exec: function (editor) {
                split()
            }
        });
        editor.commands.addCommand({
            name: 'eval',
            bindKey: {win: 'Ctrl-e', mac: 'Command-e'},
            exec: function (editor) {
                doIt()
            }
        })
      })

      function fillSnippets(){
        var list = document.getElementById('snippets'),
            split = 'Tier-splitting',
            normal = 'JavaScript',
            head = document.createElement('li'),
            i = 0;
        head.appendChild(document.createTextNode(split));
        list.appendChild(head);
        Examples.tiersplittxt.map(function (txt) {
            var li = document.createElement('li'),
                a = document.createElement('a');
            a.appendChild(document.createTextNode(txt));
            a.setAttribute('data-value', i);
            a.setAttribute('role', 'menuitem')
            i++;
            li.appendChild(a);
            li.setAttribute('role', 'presentation')
            list.appendChild(li);
        });
        head = document.createElement('li');
        head.appendChild(document.createTextNode(normal));
        list.appendChild(head);
        Examples.slicetxt.map(function (txt) {
            var li = document.createElement('li'),
                a = document.createElement('a');
            a.appendChild(document.createTextNode(txt));
            a.setAttribute('data-value', i);
            i++;
            li.appendChild(a);
            list.appendChild(li);
        });
      };

  </script>
</head>

<body>
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">         
                    <span class="sr-only">Toggle navigation</span>          
                    <span class="icon-bar"></span>          
                    <span class="icon-bar"></span>          
                    <span class="icon-bar"></span>        
                </button>
                <img src="imgs/stip-white.png" style="height:55px;">
            </div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="stip.html">Home</a></li>
                    <li><a href="howto.html">How to</a></li>
                    <li><a href="about.html">About</a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div> <!--/.container -->
    </div> <!-- /.navbar -->
    <div class="container theme-showcase" role="main">
        <div class="jumbotron" >
            <div class="row" arylw="table-layout: fixed;">
                <div class="col-md-4">
                    <img src="imgs/stip.png"/>
                </div>
                <div class="col-md-6" style="display: table !important; height: 170px;">
                    <div style= "display: table-cell; vertical-align:middle;">
                        <p class="lead">Slicing Tierless Programs in JavaScript </p>
                        <p class="small"> This is a first prototype of the tier splitting tool Stip.js. 
                        (tested on Chrome and Firefox)</p>
                    </div>
                </div>
            </div>
        </div> <!-- /.jumbotron -->
        <div id= "code">
            <div class="well row" style="margin-left: 0px; margin-right: 0px; margin-top: 5px; margin-bottom: 5px;">
                <div class="col-md-6"> 
                    <h4 style="float:left;">Your JavaScript code:</h4>
                    <div class="dropdown" style="float: right;">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" 
                                id="dropdownSnippets" style="float:right;">
                            Snippets
                            <span class="caret"></span>
                        </button>
                        <ul id="snippets" aria-labelledby="dropdownSnippets" class="dropdown-menu" role="menu"></ul>
                    </div>
                    <div id="editor" style="height: 350px; width:100%;"></div>
                </div>
                <div class="col-md-6"> 
                    <div class="row">
                        <h4 style="float:left;">Sliced code:</h4>
                        <div class="form-inline" id="editordashboard" style="float:right; margin:4px;">
                           <div class="checkbox">
                                <input data-toggle="toggle" data-size="small" type="checkbox" id="includeclient" data-on="client" data-off="client" checked>
                            </div>
                            <div class="checkbox">
                                <input data-toggle="toggle" data-size="small" type="checkbox" id="includeserver" data-on="server" data-off="server" checked>
                            </div>
                            <div class="checkbox">
                                <input data-toggle="toggle" data-size="small" type="checkbox" id="includesetup" data-on="setup" data-off="setup">
                            </div>
                        </div>
                    </div>
                   <div class="row" id="slicededitor" style="height: 350px;"></div>
                </div>
            </div>


            <div class="well">
                <!-- Tool tabs -->
                <ul class="nav nav-tabs">
                    <li class="active"><a href="#stip" data-toggle="tab">STiP</a></li>
                    <li><a href="#jipda" data-toggle="tab">Jipda</a></li>
                    <li><a href="#esprima" data-toggle="tab">Esprima</a></li>
                    <li><a href="#jslint" data-toggle="tab">JSLint</a></li>
                </ul>  
                <!-- ./ Tool tabs-->

                <div class="tab-content">
                    <!-- Stip -->
                    <div class="tab-pane active" id="stip">
                        <div class="container">
                            <div id="manip" style="margin-top: 1%;">
                                <button id="eval" name="eval" onClick="doIt()" class="btn btn-success" 
                                        style="float: left; margin-right: 10px">Eval</button> 
                                <p style="float: left; margin-right: 10px; padding-top:1%"> or </p>
                                <button id="cpstransform" name="cpstransform" onClick="cpstransform()" class="btn btn-success" 
                                        style="float: left; margin-right: 10px">Transform CPS</button> 
                                <p style="float: left; margin-right: 10px; padding-top:1%"> or </p>
                                <button id="split" name="split"  class="btn btn-success" 
                                        data-toggle="collapse" data-target="#splitconfig" aria-expanded="false"
                                        aria-controls="splitconfig"
                                        style="float: left; margin-right: 10px">Tier split</button> 
                                <div class="collapse" id="splitconfig" style="float:left">
                                    <div class="well">
                
                                            <div class="form-group">
                                                <label for="target">Target</label>
                                                <select class="form-control" id="target">
                                                    <option>node.js</option>
                                                    <option>meteor</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label for="asyncomm">Asynchronous Communication</label>
                                                <select class="form-control" id="asyncomm">
                                                    <option>callbacks</option>
                                                    <option>promises</option>
                                                </select>
                                            </div>
                                          <button onClick="split()" class="btn btn-default">Split!</button>
                                
                                    </div>
                                </div>
                            </div> <!-- /.manip -->
                            <!-- <p id="error" style="float:left;"></p> -->
                        </div> <!-- /.container -->
                        
                         <div id="error" style="color: #ff0606;"> </div>
                         <div id="graphcont">
                            <div><!-- id="graph" class="container panzoom"> -->
                                <svg>
                                    <g transform="translate(20,20)"/>
                                </svg>
                                <div class="fixed tooltip"></div>
                            </div>
                        </div>
                    </div> <!-- ./stip -->

                    <!-- Jipda -->
                    <div class="tab-pane" id="jipda">
                        <div class="container">
                            <button id="jipdaeval" name="jipdaeval" onClick="jipdaIt()" class="btn btn-success" 
                                    style="float: left; margin-right: 10px; margin-top: 1%;">Eval</button>
                            <span id="resultValue"></span>
                                <div id="meta">
                                    <div id="output"></div>
                                    <div id="input"></div>
                                </div>
                                <div id="right" class="container">
                                    <div id="graphjipda" class="container">
                                        <svg>
                                            <defs>
                                                <marker id="highlightarrowhead" viewBox="0 0 10 10" refX="8" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="5" orient="auto">
                                                    <path d="M 0 0 L 10 5 L 0 10 z"></path>
                                                </marker>
                                            </defs> 
                                        <g transform="translate(20,20)"/>
                                        </svg>
                                    </div>
                                </div>
                                <!-- /.right -->
                        </div>
                    </div> <!-- ./jipda -->

                    <!-- Esprima -->
                    <div class="tab-pane" id="esprima">
                        <div class="container">
                            <button id="esprimaparse" name="esprimaparse" onClick="esprimaparse()" class="btn btn-success" 
                                    style="float: left; margin-right: 10px;margin-top: 1%;">Parse</button>
                            <div style="float:left">
                                <h4>Syntax</h4>
                                <textarea id="syntax" rows="30" cols="60" readonly></textarea> 
                            </div>
                            <div style="margin-top:1%">
                                <h4>Tree view </h4>
                                <div id="treeview"></div>
                            </div>
                        </div>
                    </div> <!--./esprima -->

                    <!-- JSLint -->
                    <div class="tab-pane" id="jslint">
                        <div class="container">
                            <div style="float: left; margin-top: 1%;">
                                <button id="jslintbtn" name="jslint" onClick="jslint()" class="btn btn-success" 
                                        style="float: left; margin-right: 10px">JSLint</button>
                            </div>
                            <ul class="nav nav-tabs" id="jslinttab">
                                <li class="active"><a href="#jslinterrors" data-toggle="tab">Error report</a></li>
                                <li><a href="#jslintfunction" data-toggle="tab">Function report</a></li>
                                <li><a href="#jslintproperties" data-toggle="tab">Properties report</a></li>
                            </ul>  
                            <div class="tab-content" style="margin-top: 2%;">
                                <div class="tab-pane active" id="jslinterrors"></div>
                                <div class="tab-pane" id="jslintfunction"></div>
                                <div class="tab-pane" id="jslintproperties"></div>
                            </div>
                        </div>
                    </div> <!-- jslint -->

                </div> <!--./tabcontent -->     
            </div> <!-- ./well -->
        </div>  <!-- ./code -->     
    </div> <!-- ./main container -->


    </body>
    <script type="text/javascript">
        fillSnippets();
        $(".dropdown-menu li a").click(function () {
                var value = $(this).data('value'),
                    nr_splits = Examples.tiersplitexs.length,
                    text = '',
                    editor = ace.edit("editor");
                if(value >= nr_splits) 
                    text = Examples.sliceexs[value - nr_splits];
                else
                    text = Examples.tiersplitexs[value];
                editor.setValue(text);
                editor.gotoLine(0);
        })
        $("#includeclient").change(function () {
            printCode();
        })
        $("#includeserver").change(function () {
            printCode();
        })
        $("#includesetup").change(function () {
            printCode();
        })

    </script>
    <script src="js/jquery.panzoom//test/libs/jquery.js"></script>
    <script src="js/jquery.panzoom/dist/jquery.panzoom.js"></script>

    </html>

